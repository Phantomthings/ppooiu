# AC : S01 - SEQ AFE - IC 
IC1_SEQ01_MAP = {
    0:  "IC00 - 080Q1 - [NX_OBI_400VAC_Q_Flt] - 400VAC - CB Open",
    1:  "IC01 - 080Q1 - [NX_OBI_400VAC_ElecFLT] - 400VAC - Electrical Fault Flt",
    2:  "IC02 - 081Q1-081F1 - [NX_OBI_LIGHTARR_FLT] - NX PARAFOUDRE Flt",
    3:  "IC03 - [CU_OBI_400VAC_Q_Flt] - 400VAC Main circuit breakers Cooling unit Open",
    4:  "IC04 - [AUX_OBI_400VAC_Q_Flt] - 400VAC Main circuit breakers Open",
    5:  "IC05 - [UPS_OBI_IN230VAC_Q_Flt] - 230VAC Main circuit breakers UPS INPUT Open",
    6:  "IC06 - [IMD_IBH_230VAC_Q] - 230VAC circuit breakers IMD Open",
    7:  "IC07 - 110Q1 - [UPS_OBI_OUT230VAC_Q_Flt] - 230VAC Main circuit breakers UPS OUT Open",
    8:  "IC08 - [REL_OBI_230VAC_Q_Flt] - 230VAC UPS Relay Circuit breaker Open",
    9:  "IC09 - [IMD_OBI_230VAC_Q_Flt] - 230VAC circuit breakers IMD Open",
    10: "IC10 - [LOV_AU_OBI_230VAC_Q_Flt] - 230VAC circuit breakers Measurement + AU Open",
    11: "",
    12: "",
    13: "",
    14: "IC14 - 105Q1 - [EXTGAZ_OBI_400VAC_Q_Flt] - 400VAC Circuit breaker GAZ Extractor Open",
    15: "IC15 - 105Q2 - [EXTGAZ_OBI_K] - Gaz Extractor RUN Open",
    16: "IC16 - 159Q1 - [AFE1_OBI_ACPL_F_FLT] - AFE1 AC Preload fuses - Fuse FLT Open",
    17: "IC17 - 193KM1 - [AFE1_OBI_AC_Q_Flt] - AFE1 AC Circuit breaker",
    18: "IC18 - 193K1 - [AFE1_OBI_ACPL_K] - AFE1 DC Preload contactor",
    19: "IC19 - [AMS_OBI_AFE1_ComFlt] AFE1 Loss communication",
    20: "IC20 - [IMD_OBI_DefCom] Loss communication",
    21: "IC21 - [AMS_OBI_RIO_ComFlt] RIO Loss communication",
    22: "IC22 - [AMS_OBI_Lovato_ComFlt] Lovato Loss communication",
    23: "IC23 - [AMS_OBI_CU_ComFlt] Loss communication",
    24: "IC24 - AFE VDC Measurement < 490VDC",
    25: "",
    26: "",
    27: "",
    28: "",
    29: "",
    30: "",
    31: "",
}

# AC : S01 - SEQ AFE - PC
PC1_SEQ01_MAP = {
    0:  "PC00 - 080Q1 - [NX_OBI_400VAC_Q_Flt] - 400VAC - CB Open",
    1:  "PC01 - 080Q1 - [NX_OBI_400VAC_ElecFLT] - 400VAC - Electrical Fault Flt",
    2:  "PC02 - 081Q1-081F1 - [NX_OBI_LIGHTARR_FLT] - NX PARAFOUDRE Flt",
    3:  "PC03 - [CU_OBI_400VAC_Q_Flt] - 400VAC Main circuit breakers Cooling unit Open",
    4:  "PC04 - [AUX_OBI_400VAC_Q_Flt] - 400VAC Main circuit breakers Open",
    5:  "PC05 - 110Q1 - [UPS_OBI_OUT230VAC_Q_Flt] - 230VAC Main circuit breakers UPS OUT Open",
    6:  "PC06 - [REL_OBI_230VAC_Q_Flt] - 230VAC UPS Relay circuit breaker Open",
    7:  "PC07 - 112Q2 - [IMD_OBI_230VAC_Q_Flt] - 230VAC circuit breakers IMD Open",
    8:  "PC08 - [NX_OBI_400VAC_DecouplingFLT] - AV Relay Decoupling Flt",
    9:  "PC09 - 351S1 - [BP_OBI_AU_EXT_FLT] - ES Push button External Open",
    10: "PC10 - 105Q1 - [EXTGAZ_OBI_400VAC_Q_Flt] - 400VAC Circuit breaker GAZ Extractor Open",
    11: "PC11 - 105Q2 - [EXTGAZ_OBI_K] - Gaz Extractor RUN Open",
    12: "PC12 - 24VDC - IO_IBH_24VDC_ON / SAFE_IBH_24VDC_ON / GAPA_IBH_24VDC_ON - 24VDC UPS Voltage ON",
    13: "PC13 - [AMS_OBI_AFE1_ComFlt] AFE1 Loss communication",
    14: "PC14 - 155F1 - [IMD_OBI_Flt] - Controleur permanent d’isolement Flt",
    15: "PC15 - [AMS_OBI_RIO_ComFlt] RIO Loss communication",
    16: "PC16 - [AMS_OBI_Lovato_ComFlt] Lovato Loss communication",
    17: "PC17 - [AMS_OBI_CU_ComFlt] Loss communication",
    18: "PC18 - 193K1 - [AFE1_OBI_ACPL_K_DiscKM] - AFE1 DC Preload contactor",
    19: "PC19 - 193K1 - [AFE1_OBI_ACPL_K_DiscKM] - AFE1 DC Preload contactor (dup.)",
    20: "PC20 - 193KM1 - [AFE1_OBI_AC_K_DiscKM] - Discordance AFE DC Line contactor",
    21: "PC21 - AFE1 FAULT",
    22: "PC22 - AFE1 voltage input flt",
    23: "PC23 - AFE1 tension < 150VDC",
    24: "PC24 - 155F2 - [SAFE_OBI_ON_FLT] - ES LIVE Flt",
    25: "PC25 - 155F1 - [IMD_OBI_Flt] - Controleur permanent d’isolement Communication fault",
    26: "PC26 - 1505Q1 - [FIRE_OBI_Q_Flt / FIRE_OBI_GazRelease_FLT] - alarme incendie",
    27: "PC27 - Conteneur température fault",
    28: "PC28 - Fire System Fault",
    29: "PC29 - Manual Force STOP",
    30: "PC30 - SEQ TimeOut STEP",
    31: "PC31 - Doors open",
}
# DC1 : SEQ02 - IC 
IC1_SEQ02_MAP = {
    0:  "IC00 - BBMS1 No Relay closed",
    1:  "IC01 - 111Q2 - [HB1_IBH_230VAC_Q] - 230VAC UPS HB1 circuit breaker Hacheur BATT1 Open",
    2:  "IC02 - Manual disable HB",
    3:  "IC03 - SEQ01 [SEQ01.OLI.Branch_01] AFE - Is Step 100",
    4:  "",
    5:  "",
    6:  "",
    7:  "",
    8:  "",
    9:  "",
    10: "",
    11: "",
    12: "",
    13: "",
    14: "",
    15: "",
    16: "",
    17: "",
    18: "",
    19: "",
    20: "",
    21: "",
    22: "",
    23: "",
    24: "",
    25: "",
    26: "",
    27: "",
    28: "",
    29: "",
    30: "",
    31: "",
}

# DC1 : SEQ02 - PC 
PC1_SEQ02_MAP = {
    0:  "PC00 - 360F1 - SAFE_OBI_ON_FLT - ES LIVE Flt",
    1:  "PC01 - [AMS_OBI_RIO_ComFlt] - RIO Loss communication",
    2:  "PC02 - SEQ01 - AFE - Is Step 100",
    3:  "PC03 - [AMS_OBI_HB1_ComFlt] Hacheur1 Loss communication",
    4:  "PC04 - BBMS1 - Loss Communication",
    5:  "PC05 - BBMS1 Fault",
    6:  "PC06 - HB1 - FAULT",
    7:  "PC07 - 206Q1 - [HB1_OBI_OUTDC_K_ICPCFlt] - HB1 OUT DC Contactor running condition missing",
    8:  "PC08 - 111Q2 - [HB1_IBH_230VAC_Q] - 230VAC UPS HB1 circuit breaker Hacheur BATT1",
    9:  "PC09 - 111Q5 - [HB_IBH_Measure230VAC_Q] - 230VAC Circuit breaker - Measurement circuit",
    10: "PC10 - 24VDC UPS BBMS Voltage ON Open",
    11: "PC11 - 24VDC UPS Rack1_2 Voltage ON Open",
    12: "PC12 - HB1 BATT1 Reactor temperature Fault",
    13: "PC13 - 210K1 - [GAPA_OBI_24VDC_ON_ICPCFlt] - GAPA 24V VDC Contactor running condition missing",
    14: "PC14 - BBMS1 No Relay closed",
    15: "",
    16: "PC16 - SEQ02 TimeOut - TimeOut 10",
    17: "PC17 - SEQ02 TimeOut - TimeOut 20",
    18: "PC18 - SEQ02 TimeOut - TimeOut 30",
    19: "PC19 - SEQ02 TimeOut - TimeOut 40",
    20: "PC20 - SEQ02 TimeOut - TimeOut 60",
    21: "",
    22: "",
    23: "",
    24: "",
    25: "",
    26: "",
    27: "",
    28: "",
    29: "",
    30: "",
    31: "",
}
IC1_SEQ03_MAP = {
    0:  "IC00 - BBMS2 No Relay closed",
    1:  "IC01 - 111Q3 - [HB1_IBH_230VAC_Q] - 230VAC UPS HB1 circuit breaker Hacheur BATT1 Open",
    2:  "IC02 - Manual disable HB",
    3:  "IC03 - SEQ01 [SEQ01.OLI.Branch_01] AFE - Is Step 100",
    4:  "",
    5:  "",
    6:  "",
    7:  "",
    8:  "",
    9:  "",
    10: "",
    11: "",
    12: "",
    13: "",
    14: "",
    15: "",
    16: "",
    17: "",
    18: "",
    19: "",
    20: "",
    21: "",
    22: "",
    23: "",
    24: "",
    25: "",
    26: "",
    27: "",
    28: "",
    29: "",
    30: "",
    31: "",
}
# DC2 : SEQ03 - PC 
PC1_SEQ03_MAP = {
    0:  "PC00 - 360F1 - SAFE_OBI_ON_FLT - ES LIVE Flt",
    1:  "PC01 - [AMS_OBI_RIO_ComFlt] - RIO Loss communication",
    2:  "PC02 - SEQ01 - AFE - Is Step 100",
    3:  "PC03 - [AMS_OBI_HB2_ComFlt] Hacheur1 Loss communication",
    4:  "PC04 - BBMS2 - Loss Communication",
    5:  "PC05 - BBMS2 Fault",
    6:  "PC06 - HB2 - FAULT",
    7:  "PC07 - 246Q1 - [HB1_OBI_OUTDC_K_ICPCFlt] - HB1 OUT DC Contactor running condition missing",
    8:  "PC08 - 111Q3 - [HB1_IBH_230VAC_Q] - 230VAC UPS HB1 circuit breaker Hacheur BATT1",
    9:  "PC09 - 111Q5 - [HB_IBH_Measure230VAC_Q] - 230VAC Circuit breaker - Measurement circuit",
    10: "PC10 - 24VDC UPS BBMS Voltage ON Open",
    11: "PC11 - 24VDC UPS Rack1_2 Voltage ON Open",
    12: "PC12 - HB2 BATT2 Reactor temperature Fault",
    13: "PC13 - 210K1 - [GAPA_OBI_24VDC_ON_ICPCFlt] - GAPA 24V VDC Contactor running condition missing",
    14: "PC14 - BBMS1 No Relay closed",
    15: "",
    16: "PC16 - SEQ03 TimeOut - TimeOut 10",
    17: "PC17 - SEQ03 TimeOut - TimeOut 20",
    18: "PC18 - SEQ03 TimeOut - TimeOut 30",
    19: "PC19 - SEQ03 TimeOut - TimeOut 40",
    20: "PC20 - SEQ03 TimeOut - TimeOut 60",
    21: "",
    22: "",
    23: "",
    24: "",
    25: "",
    26: "",
    27: "",
    28: "",
    29: "",
    30: "",
    31: "",
}

#PDC
PDC_SEQ_IC_MAP = {
    0:  "IC00 - Main sequence running",
    1:  "IC01 - Ev contactor not closed",
    2:  "IC02 - No over temp Self",
    3:  "",
    4:  "IC04 - ",
    5:  "",
    6:  "IC06 - EndPoint OCPP Connected",
    7:  "IC07 - HMI communication Fault",
    8:  "IC08 - Not charging",
    9:  "IC09 - DCBM Fault",
    10: "IC10 - Unavailable from CPO",
    11: "IC11 - Payter Com Fault",
    12: "IC12 - ZMQ Com Fault",
    13: "",
    14: "",
    15: "",
    16: "",
    17: "",
    18: "",
    19: "",
    20: "",
    21: "",
    22: "",
    23: "",
    24: "",
    25: "",
    26: "",
    27: "",
    28: "",
    29: "",
    30: "",
    31: "",
}
PDC_SEQ_PC_MAP = {
    0:  "PC00 - RIO COM",
    1:  "PC01 - ",
    2:  "PC02 - Inverter M1 Ready",
    3:  "PC03 - UpstreamSequence no fault",
    4:  "PC04 - Ev contactor no discordance",
    5:  "PC05 - ",
    6:  "PC06 - No over temp Self",
    7:  "PC07 - No TO",
    8:  "PC08 - Plug no Over Temp CCS",
    9:  "PC09 - Inverter OverVoltage",
    10: "PC10 - ",
    11: "PC11 - ",
    12: "PC12 - Communication EVI",
    13: "PC13 - ES EVI",
    14: "PC14 - Manual Indispo",
    15: "PC15 - HMI communication Fault",
    16: "",
    17: "",
    18: "",
    19: "",
    20: "",
    21: "",
    22: "",
    23: "",
    24: "",
    25: "",
    26: "",
    27: "",
    28: "",
    29: "",
    30: "",
    31: "",
}
EQUIP_CONFIG = {
    "AC":  {
        "ic_field": "SEQ01.OLI.A.IC1",
        "pc_field": "SEQ01.OLI.A.PC1",
        "ic_map": IC1_SEQ01_MAP,
        "pc_map": PC1_SEQ01_MAP,
        "title": "AC (SEQ01)",
    },
    "DC1": {
        "ic_field": "SEQ02.OLI.A.IC1",
        "pc_field": "SEQ02.OLI.A.PC1",
        "ic_map": IC1_SEQ02_MAP,
        "pc_map": PC1_SEQ02_MAP,
        "title": "Batterie DC1 (SEQ02)",
    },
    "DC2": {
        "ic_field": "SEQ03.OLI.A.IC1",
        "pc_field": "SEQ03.OLI.A.PC1",
        "ic_map": IC1_SEQ03_MAP,
        "pc_map": PC1_SEQ03_MAP,
        "title": "Batterie DC2 (SEQ03)",
    },
    "PDC1": {
        "ic_field": "SEQ12.OLI.A.IC1",
        "pc_field": "SEQ12.OLI.A.PC1",
        "ic_map": PDC_SEQ_IC_MAP,
        "pc_map": PDC_SEQ_PC_MAP,
        "title": "Point de charge 1 (SEQ12)",
    },
    "PDC2": {
        "ic_field": "SEQ22.OLI.A.IC1",
        "pc_field": "SEQ22.OLI.A.PC1",
        "ic_map": PDC_SEQ_IC_MAP,
        "pc_map": PDC_SEQ_PC_MAP,
        "title": "Point de charge 2 (SEQ22)",
    },
    "PDC3": {
        "ic_field": "SEQ13.OLI.A.IC1",
        "pc_field": "SEQ13.OLI.A.PC1",
        "ic_map": PDC_SEQ_IC_MAP,
        "pc_map": PDC_SEQ_PC_MAP,
        "title": "Point de charge 3 (SEQ13)",
    },
    "PDC4": {
        "ic_field": "SEQ23.OLI.A.IC1",
        "pc_field": "SEQ23.OLI.A.PC1",
        "ic_map": PDC_SEQ_IC_MAP,
        "pc_map": PDC_SEQ_PC_MAP,
        "title": "Point de charge 4 (SEQ23)",
    },
    "PDC5": {
        "ic_field": "SEQ14.OLI.A.IC1",
        "pc_field": "SEQ14.OLI.A.PC1",
        "ic_map": PDC_SEQ_IC_MAP,
        "pc_map": PDC_SEQ_PC_MAP,
        "title": "Point de charge 5 (SEQ14)",
    },
    "PDC6": {
        "ic_field": "SEQ24.OLI.A.IC1",
        "pc_field": "SEQ24.OLI.A.PC1",
        "ic_map": PDC_SEQ_IC_MAP,
        "pc_map": PDC_SEQ_PC_MAP,
        "title": "Point de charge 6 (SEQ24)",
    },
}
def get_equip_config(equipement_id: str):
    return EQUIP_CONFIG.get(equipement_id or "AC", EQUIP_CONFIG["AC"])

def _u32(x: int) -> int:
    return x & 0xFFFFFFFF

def decode_bits(value: int | None, mapping: dict[int, str]) -> list[str]:
    if value is None:
        return []
    m = _u32(int(value))
    out = []
    for bit, label in mapping.items():
        if m & (1 << bit):
            out.append(label)
    return out

def translate_ic_pc(ic1_val: int | None, pc1_val: int | None, ic_map: dict, pc_map: dict) -> str:
    pc_causes = decode_bits(pc1_val, pc_map)
    ic_causes = decode_bits(ic1_val, ic_map)
    parts = []
    if pc_causes: parts.append("PC1: " + " ; ".join(pc_causes))
    if ic_causes: parts.append("IC1: " + " ; ".join(ic_causes))
    return " | ".join(parts)